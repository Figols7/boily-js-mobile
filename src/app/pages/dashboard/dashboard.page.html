<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>Dashboard</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="logout()">
        <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="dashboard-container">
    <!-- Welcome Header -->
    <div class="welcome-header">
      <h1>{{ getWelcomeMessage() }}</h1>
      <p class="subtitle">Here's what's happening with your account</p>
    </div>

    <!-- Subscription Status Card -->
    @if (subscription(); as sub) {
    <ion-card class="subscription-card">
      <ion-card-header>
        <div class="card-header-content">
          <ion-card-title>
            <ion-badge [color]="getPlanBadgeColor(sub.planType)">
              {{ sub.planType | uppercase }}
            </ion-badge>
          </ion-card-title>
          <ion-badge [color]="getSubscriptionStatusColor(sub.status)">
            {{ sub.status }}
          </ion-badge>
        </div>
      </ion-card-header>

      <ion-card-content>
        <!-- Trial Info -->
        @if (isTrial()) {
          <div class="info-row">
            <ion-icon name="time-outline" color="primary"></ion-icon>
            <div class="info-content">
              <span class="info-label">Trial Period</span>
              <span class="info-value">{{ getDaysRemaining() }} days remaining</span>
            </div>
          </div>
        }

        <!-- Billing Period -->
        @if (isActive()) {
          <div class="info-row">
            <ion-icon name="calendar-outline" color="primary"></ion-icon>
            <div class="info-content">
              <span class="info-label">Current Period</span>
              <span class="info-value">
                {{ formatDate(sub.currentPeriodStart) }} - {{ formatDate(sub.currentPeriodEnd) }}
              </span>
            </div>
          </div>
        }

        <!-- Price -->
        @if (sub.planType !== PlanType.STARTER) {
          <div class="info-row">
            <ion-icon name="card-outline" color="primary"></ion-icon>
            <div class="info-content">
              <span class="info-label">{{ sub.isYearly ? 'Yearly' : 'Monthly' }} Cost</span>
              <span class="info-value">
                {{ formatCurrency(sub.isYearly ? sub.yearlyPrice * 100 : sub.monthlyPrice * 100) }}
              </span>
            </div>
          </div>
        }

        <!-- Action Buttons -->
        <div class="button-group">
          @if (sub.planType === PlanType.STARTER) {
            <ion-button
              expand="block"
              fill="outline"
              size="small"
              (click)="navigateToPricing()"
            >
              <ion-icon name="rocket-outline" slot="start"></ion-icon>
              Upgrade Plan
            </ion-button>
          }

          @if (sub.planType !== PlanType.STARTER) {
            <ion-button
              expand="block"
              fill="outline"
              size="small"
              (click)="manageBilling()"
            >
              <ion-icon name="card-outline" slot="start"></ion-icon>
              Manage Billing
            </ion-button>
          }

          @if (isActive() && sub.planType !== PlanType.STARTER) {
            <ion-button
              expand="block"
              fill="clear"
              size="small"
              color="danger"
              (click)="cancelSubscription()"
            >
              Cancel Subscription
            </ion-button>
          }
        </div>
      </ion-card-content>
    </ion-card>
    }

    <!-- API Usage Card -->
    @if (subscription(); as sub) {
    <ion-card class="usage-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="analytics-outline"></ion-icon>
          API Usage
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <div class="usage-stats">
          <div class="usage-numbers">
            <span class="usage-current">{{ sub.currentApiUsage }}</span>
            <span class="usage-divider">/</span>
            <span class="usage-limit">
              {{ sub.monthlyApiLimit === -1 ? 'Unlimited' : sub.monthlyApiLimit }}
            </span>
          </div>

          <ion-progress-bar
            [value]="apiUsagePercentage() / 100"
            [color]="getApiUsageColor()"
            class="usage-bar"
          ></ion-progress-bar>

          <div class="usage-percentage">
            {{ apiUsagePercentage().toFixed(1) }}% used
          </div>
        </div>

        @if (isApproachingLimit()) {
          <ion-chip color="warning">
            <ion-icon name="warning-outline"></ion-icon>
            <ion-label>Approaching Limit</ion-label>
          </ion-chip>
        }

        @if (subscriptionService.isApiLimitReached()) {
          <ion-chip color="danger">
            <ion-icon name="ban-outline"></ion-icon>
            <ion-label>Limit Reached</ion-label>
          </ion-chip>
        }
      </ion-card-content>
    </ion-card>
    }

    <!-- Usage Stats Card -->
    @if (usageStats) {
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="stats-chart-outline"></ion-icon>
          Usage Statistics
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-list lines="none">
          <ion-item>
            <ion-icon name="people-outline" slot="start" color="primary"></ion-icon>
            <ion-label>
              <h3>Team Members</h3>
              <p>{{ usageStats.teamMembers.used }} /
                 {{ usageStats.teamMembers.unlimited ? 'Unlimited' : usageStats.teamMembers.limit }}</p>
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-icon name="calendar-outline" slot="start" color="secondary"></ion-icon>
            <ion-label>
              <h3>Billing Period</h3>
              <p>{{ formatDate(usageStats.billingPeriod.start) }} -
                 {{ formatDate(usageStats.billingPeriod.end) }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
    }

    <!-- Recent Billing History -->
    @if (billingHistory && billingHistory.length > 0) {
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="receipt-outline"></ion-icon>
          Recent Invoices
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-list lines="inset">
          @for (invoice of billingHistory.slice(0, 5); track invoice.id || invoice.number) {
            <ion-item>
              <ion-icon
                [name]="invoice.status === 'paid' ? 'checkmark-circle' : 'alert-circle'"
                [color]="invoice.status === 'paid' ? 'success' : 'warning'"
                slot="start"
              ></ion-icon>
              <ion-label>
                <h3>{{ invoice.number || 'Invoice' }}</h3>
                <p>{{ formatDate(invoice.created) }}</p>
              </ion-label>
              <ion-text slot="end" class="invoice-amount">
                {{ formatCurrency(invoice.amount) }}
              </ion-text>
            </ion-item>
          }
        </ion-list>

        <ion-button
          expand="block"
          fill="clear"
          size="small"
          (click)="manageBilling()"
        >
          View All Invoices
        </ion-button>
      </ion-card-content>
    </ion-card>
    }

    <!-- Quick Actions -->
    <div class="quick-actions">
      <h2>Quick Actions</h2>

      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <ion-card button (click)="navigateToPricing()" class="action-card">
              <ion-card-content>
                <ion-icon name="rocket-outline" color="primary"></ion-icon>
                <p>Upgrade Plan</p>
              </ion-card-content>
            </ion-card>
          </ion-col>

          <ion-col size="6">
            <ion-card button (click)="navigateToSubscription()" class="action-card">
              <ion-card-content>
                <ion-icon name="settings-outline" color="secondary"></ion-icon>
                <p>Manage Subscription</p>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- Loading State -->
    @if (isLoading) {
      <div class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading dashboard...</p>
      </div>
    }
  </div>
</ion-content>
